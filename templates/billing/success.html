<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¡Pago Exitoso! - AgroTech Digital</title>
    <link rel="shortcut icon" href="../../images/agrotech solo blanco.png">
    <link rel="stylesheet" href="../../style.css">
    <link href="https://unpkg.com/@tabler/icons-webfont@latest/tabler-icons.min.css" rel="stylesheet" />
    <script src="../../js/config.js"></script>
    <style>
        .success-container { text-align:center; padding:140px 0 60px; max-width:680px; margin:0 auto; }
        #confettiCanvas { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999; }
        .success-icon { width:96px; height:96px; border-radius:50%; background:linear-gradient(135deg,rgba(52,199,89,0.2),rgba(52,199,89,0.05)); border:2px solid rgba(52,199,89,0.3); display:flex; align-items:center; justify-content:center; margin:0 auto 32px; animation:scaleIn 0.5s cubic-bezier(0.34,1.56,0.64,1); }
        .success-icon i { font-size:44px; color:var(--verde-claro); }
        @keyframes scaleIn { 0%{transform:scale(0);opacity:0;} 100%{transform:scale(1);opacity:1;} }
        .success-container h1 { font-size:clamp(28px,5vw,44px); font-weight:800; letter-spacing:-0.03em; margin-bottom:12px; }
        .success-container .subtitle { font-size:17px; color:var(--gris-400); margin-bottom:48px; }
        .details-card { background:var(--gris-950); border:1px solid rgba(255,255,255,0.06); border-radius:var(--radius-xl); padding:36px; text-align:left; margin-bottom:32px; }
        .details-card h3 { font-size:16px; font-weight:700; margin-bottom:20px; display:flex; align-items:center; gap:8px; }
        .details-card h3 i { color:var(--verde-claro); }
        .detail-row { display:flex; justify-content:space-between; align-items:center; padding:14px 0; border-bottom:1px solid rgba(255,255,255,0.04); font-size:14px; }
        .detail-row:last-child { border-bottom:none; }
        .detail-row .label { color:var(--gris-400); }
        .detail-row .value { font-weight:600; }
        .status-badge { display:inline-flex; align-items:center; gap:6px; background:rgba(52,199,89,0.15); color:var(--verde-claro); padding:4px 14px; border-radius:980px; font-size:13px; font-weight:600; }
        .status-badge::before { content:''; width:6px; height:6px; background:var(--verde-claro); border-radius:50%; }
        .next-steps { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-bottom:40px; }
        .step-card { background:var(--gris-950); border:1px solid rgba(255,255,255,0.06); border-radius:16px; padding:24px 20px; text-align:center; transition:var(--transition-smooth); }
        .step-card:hover { border-color:rgba(255,255,255,0.12); transform:translateY(-2px); }
        .step-card .snum { width:36px; height:36px; display:flex; align-items:center; justify-content:center; margin:0 auto 12px; background:rgba(52,199,89,0.12); border-radius:10px; color:var(--verde-claro); font-size:14px; font-weight:800; }
        .step-card h4 { font-size:14px; font-weight:600; margin-bottom:6px; }
        .step-card p { font-size:13px; color:var(--gris-400); margin:0; line-height:1.5; }
        .btn-dashboard { display:inline-flex; align-items:center; gap:10px; padding:16px 40px; background:var(--verde-claro); color:#000; border:none; border-radius:980px; font-size:16px; font-weight:700; font-family:'Inter',sans-serif; cursor:pointer; transition:var(--transition-smooth); text-decoration:none; }
        .btn-dashboard:hover { background:var(--verde-accent); box-shadow:0 8px 24px rgba(52,199,89,0.3); transform:scale(1.02); color:#000; }
        .btn-secondary-link { display:inline-flex; align-items:center; gap:8px; margin-top:16px; font-size:14px; font-weight:500; color:var(--gris-400); text-decoration:none; transition:var(--transition-smooth); }
        .btn-secondary-link:hover { color:var(--verde-claro); }
        .confirm-status { margin-top:12px; font-size:13px; color:var(--gris-600); display:none; }
        .confirm-status.show { display:block; }
        .confirm-status.success { color:var(--verde-claro); }
        .confirm-status.error { color:#FF453A; }
        @media(max-width:640px) { .next-steps{grid-template-columns:1fr;} .success-container{padding:100px 0 40px;} }
    </style>
    <!-- Global Mobile Responsive -->
    <link href="../../css/global-mobile-responsive.css" rel="stylesheet" type="text/css" />
</head>
<body>
    <canvas id="confettiCanvas"></canvas>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-content">
                <div class="logo">
                    <img src="../../images/agrotech solo blanco.png" alt="AgroTech Digital">
                    <span>AgroTech Digital</span>
                </div>
                <div class="nav-menu">
                    <a href="../../index.html#features">Características</a>
                    <a href="pricing.html">Planes</a>
                    <a href="../authentication/login.html" class="btn-primary-nav">Iniciar Sesión</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="success-container">
            <div class="success-icon"><i class="ti ti-circle-check"></i></div>
            <h1 id="successTitle">¡Pago realizado con éxito!</h1>
            <p class="subtitle" id="successSubtitle">Bienvenido a AgroTech Digital Premium. Tu suscripción está activa.</p>

            <div class="details-card">
                <h3><i class="ti ti-receipt"></i> Detalles de tu suscripción</h3>
                <div class="detail-row"><span class="label">Plan</span><span class="value" id="detailPlan">—</span></div>
                <div class="detail-row"><span class="label">Ciclo</span><span class="value" id="detailCycle">—</span></div>
                <div class="detail-row"><span class="label">ID de suscripción</span><span class="value" id="detailSubId">—</span></div>
                <div class="detail-row"><span class="label">Estado</span><span class="status-badge" id="detailStatus">Activo</span></div>
                <div class="confirm-status" id="confirmStatus"></div>
            </div>

            <h3 style="font-size:20px;font-weight:700;margin-bottom:20px;">Próximos pasos</h3>
            <div class="next-steps">
                <div class="step-card"><div class="snum">1</div><h4>Configura tu finca</h4><p>Agrega tus parcelas y define tus cultivos.</p></div>
                <div class="step-card"><div class="snum">2</div><h4>Análisis Satelital</h4><p>Ejecuta tu primer análisis NDVI en segundos.</p></div>
                <div class="step-card"><div class="snum">3</div><h4>Optimiza</h4><p>Revisa los informes y mejora tu rendimiento.</p></div>
            </div>

            <a href="#" class="btn-dashboard" id="btnDashboard" onclick="goToDashboard(); return false;"><i class="ti ti-layout-dashboard"></i> Ir al Dashboard</a>
            <br>
            <a href="pricing.html" class="btn-secondary-link"><i class="ti ti-arrow-left"></i> Volver a planes</a>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <div class="logo">
                        <img src="../../images/agrotech solo blanco.png" alt="AgroTech Digital">
                        <span>AgroTech Digital</span>
                    </div>
                    <p>Agricultura de precisión con análisis satelital avanzado para maximizar tu producción.</p>
                </div>
                <div class="footer-col">
                    <h4>Producto</h4>
                    <a href="../../index.html#features">Características</a>
                    <a href="pricing.html">Planes</a>
                    <a href="../authentication/login.html">Iniciar Sesión</a>
                </div>
                <div class="footer-col">
                    <h4>Empresa</h4>
                    <a href="#">Sobre Nosotros</a>
                    <a href="#">Blog</a>
                    <a href="#">Contacto</a>
                </div>
                <div class="footer-col">
                    <h4>Contacto</h4>
                    <p>info@agrotechdigital.com</p>
                    <p>+57 300 123 4567</p>
                    <p>Bogotá, Colombia</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 AgroTech Digital. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script>
    function goToDashboard() {
        // Verificar si tiene tokens de sesión
        var token = localStorage.getItem('accessToken');
        if (token) {
            window.location.href = '../dashboard.html';
        } else {
            // Sin tokens → ir a login
            window.location.href = '../authentication/login.html';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        var API = window.AGROTECH_CONFIG.API_BASE;
        var params = new URLSearchParams(window.location.search);
        var planMap = {'basic':'Agricultor','pro':'Empresarial','free':'Explorador'};
        var tier = params.get('plan') || 'basic';
        var cycle = params.get('cycle') || 'monthly';
        var preapprovalId = params.get('preapproval_id') || params.get('subscription_id') || '';
        var tenantParam = params.get('tenant') || '';
        var isFree = tier === 'free';

        // Ajustar textos para plan gratuito
        if (isFree) {
            document.getElementById('successTitle').textContent = '¡Tu cuenta ha sido creada!';
            document.getElementById('successSubtitle').textContent = 'Bienvenido a AgroTech Digital. Tu trial gratuito de 14 días está activo.';
        }

        document.getElementById('detailPlan').textContent = planMap[tier] || tier;
        document.getElementById('detailCycle').textContent = isFree ? 'Trial 14 días' : (cycle === 'yearly' ? 'Anual' : 'Mensual');
        document.getElementById('detailSubId').textContent = preapprovalId || tenantParam || '—';

        var confirmStatusEl = document.getElementById('confirmStatus');

        // Verificar si ya estamos logueados (free plan ya guarda tokens en checkout)
        var hasTokens = !!localStorage.getItem('accessToken');

        // Actualizar botón de dashboard
        var btnDashboard = document.getElementById('btnDashboard');
        if (hasTokens) {
            confirmStatusEl.textContent = '✓ Tu cuenta está lista. Puedes ir al dashboard directamente.';
            confirmStatusEl.className = 'confirm-status show success';
        }

        // Para planes pagos que vienen de MercadoPago: confirmar pago y crear tenant + usuario
        if (!isFree && preapprovalId) {
            confirmStatusEl.textContent = 'Verificando pago y configurando tu espacio de trabajo...';
            confirmStatusEl.className = 'confirm-status show';

            // Recuperar datos de checkout guardados en localStorage
            var checkoutUsername = localStorage.getItem('checkout_username') || '';
            var checkoutPassword = localStorage.getItem('checkout_password') || '';
            var checkoutEmail = localStorage.getItem('checkout_email') || params.get('payer_email') || '';
            var checkoutTenant = localStorage.getItem('checkout_tenant') || '';

            fetch(API + '/billing/api/confirm-payment/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    preapproval_id: preapprovalId,
                    plan_tier: tier,
                    billing_cycle: cycle,
                    payer_email: checkoutEmail,
                    tenant_name: checkoutTenant,
                    username: checkoutUsername,
                    password: checkoutPassword,
                })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    console.log('Tenant creado/confirmado:', data);
                    confirmStatusEl.textContent = '✓ Espacio de trabajo configurado correctamente';
                    confirmStatusEl.className = 'confirm-status show success';
                    if (data.schema_name) {
                        document.getElementById('detailSubId').textContent = data.schema_name;
                    }
                    var badge = document.getElementById('detailStatus');
                    if (badge) badge.innerHTML = '<span style="color:var(--verde-claro)">✓</span> Activo y verificado';

                    // Guardar tokens para auto-login
                    if (data.tokens) {
                        localStorage.setItem('accessToken', data.tokens.access);
                        localStorage.setItem('refreshToken', data.tokens.refresh);
                        localStorage.setItem('userName', data.username || checkoutUsername);
                        localStorage.setItem('userEmail', checkoutEmail);
                        localStorage.setItem('tenantName', data.schema_name || '');
                    }

                    // Limpiar datos temporales de checkout
                    localStorage.removeItem('checkout_username');
                    localStorage.removeItem('checkout_password');
                    localStorage.removeItem('checkout_email');
                    localStorage.removeItem('checkout_tenant');
                } else {
                    confirmStatusEl.textContent = 'Tu pago fue registrado. Revisa tu email para los datos de acceso.';
                    confirmStatusEl.className = 'confirm-status show';
                }
            })
            .catch(function(err) {
                console.warn('Error confirmando pago:', err);
                confirmStatusEl.textContent = 'Tu pago fue registrado. Revisa tu email para los datos de acceso.';
                confirmStatusEl.className = 'confirm-status show';
            });
        }

        // Para plan gratuito: los tokens ya fueron guardados en checkout
        if (isFree && tenantParam) {
            var userName = localStorage.getItem('userName') || '';
            confirmStatusEl.textContent = '✓ Tu espacio de trabajo "' + tenantParam + '" está listo.' + (userName ? ' Usuario: ' + userName : '');
            confirmStatusEl.className = 'confirm-status show success';
        }

        // Confetti animation
        var canvas = document.getElementById('confettiCanvas');
        var ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        var colors = ['#34C759','#30D158','#007A20','#FF9F0A','#f5f5f7','#86868b'];
        var particles = [];
        for (var i = 0; i < 150; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height,
                w: Math.random() * 10 + 4,
                h: Math.random() * 6 + 3,
                color: colors[Math.floor(Math.random() * colors.length)],
                speed: Math.random() * 3 + 2,
                angle: Math.random() * Math.PI * 2,
                spin: (Math.random() - 0.5) * 0.1,
                drift: (Math.random() - 0.5) * 1
            });
        }
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            var alive = false;
            particles.forEach(function(p) {
                if (p.y < canvas.height + 20) alive = true;
                p.y += p.speed; p.x += p.drift; p.angle += p.spin;
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.angle);
                ctx.fillStyle = p.color;
                ctx.globalAlpha = Math.max(0, 1 - p.y / canvas.height);
                ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
                ctx.restore();
            });
            if (alive) requestAnimationFrame(animate);
            else canvas.remove();
        }
        animate();
        window.addEventListener('resize', function() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
    });
    </script>
</body>
</html>
